<!DOCTYPE html>
<html>
<head>
<title>Poker Hands VR</title>
<script src="https://aframe.io/releases/0.3.1/aframe.min.js"></script>
<script src="https://cdn.rawgit.com/AltspaceVR/aframe-altspace-component/v1.3.1/dist/aframe-altspace-component.min.js"></script>
<script src="https://sdk.altvr.com/libs/altspace.js/0.28.1/altspace.min.js"></script>
</head>
<body>
    <a-scene altspace="verticalAlign: bottom">
        <a-entity id='row1' position='0 1.1 -2.5'></a-entity>
        <a-entity id='row2' position='0 0.9 -2.5'></a-entity>
        <a-entity id='row3' position='0 1.8 -2.5'></a-entity>
        
        <a-box id="randomHand" position='-0.5 0.6 -2.5' width='0.8' height='0.25' depth='0.01' color='#000000'></a-box>
        <a-entity n-text="fontSize:1; width:4; text:Random" position="-0.5 0.6 -2.49"></a-entity>
        <a-box id="clear" position='0.5 0.6 -2.5' width='0.8' height='0.25' depth='0.01' color='#000000'></a-box>
        <a-entity n-text="fontSize:1; width:4; text:Clear" position="0.5 0.6 -2.49"></a-entity>
        
      <a-entity>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/S14.png' position='0 2.3 0' width='.72' height='1.02' transparent='true'></a-plane>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/back.png' position='0 2.3 0' width='.72' height='1.02' rotation='0 180 0' transparent='true'></a-plane>
        <a-animation to='0 360 0' easing='linear' dur='15000' repeat='indefinite'/>
        </a-entity>
      
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/S11.png' position='-0.27 0.902 0' width='.12' height='0.17' transparent='true' rotation='-90 0 0'></a-plane>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/S12.png' position='-0.135 0.902 0' width='.12' height='0.17' transparent='true' rotation='-90 0 0'></a-plane>
      <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/S13.png' position='0 0.902 0' width='.12' height='0.17' transparent='true' rotation='-90 0 0'></a-plane>
      
      
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/S10.png' position='-0.7 1.1 -0.58' width='.12' height='0.17' transparent='true' rotation='200 90 0'></a-plane>
      <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/S14.png' position='-0.7 1.1 -0.45' width='.12' height='0.17' transparent='true' rotation='200 90 180'></a-plane>
      <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/back.png' position='-0.7 1.1 -0.58' width='.12' height='0.17' transparent='true' rotation='160 -90 0'></a-plane>
      <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/back.png' position='-0.7 1.1 -0.45' width='.12' height='0.17' transparent='true' rotation='160 -90 0'></a-plane>
      
      <a-entity id='tableSurface' position='0 0.901 0' rotation='-90 0 0'>
        <a-entity n-text="fontSize:1; width:4; text:" position="-0.6 0.4 0" rotation='0 0 -90'></a-entity>
        <a-entity n-text="fontSize:1; width:4; text:" position="-0.6 -0.4 0" rotation='0 0 -90'></a-entity>
        <a-entity n-text="fontSize:1; width:4; text:" position="0.6 0.4 0" rotation='0 0 90'></a-entity>
        <a-entity n-text="fontSize:1; width:4; text:" position="0.6 -0.4 0" rotation='0 0 90'></a-entity>
        <a-entity n-text="fontSize:1; width:4; text:" position="0.4 -0.6 0" rotation='0 0 0'></a-entity>
        <a-entity n-text="fontSize:1; width:4; text:" position="-0.4 -0.6 0" rotation='0 0 0'></a-entity>
        <a-entity n-text="fontSize:1; width:4; text:" position="0.4 0.6 0" rotation='0 0 180'></a-entity>
        <a-entity n-text="fontSize:1; width:4; text:" position="-0.4 0.6 0" rotation='0 0 180'></a-entity>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/OL.png' position='-0.27 0 0' width='.13' height='0.18' transparent='true' rotation='0 0 0' color='#FFFF00'></a-plane>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/OL.png' position='-0.135 0 0' width='.13' height='0.18' transparent='true' rotation='0 0 0' color='#FFFF00'></a-plane>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/OL.png' position='0 0 0' width='.13' height='0.18' transparent='true' rotation='0 0 0' color='#FFFF00'></a-plane>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/OL.png' position='0.135 0 0' width='.13' height='0.18' transparent='true' rotation='0 0 0' color='#FFFF00'></a-plane>
        <a-plane src='https://bengarfield.github.io/AltVR-Tests/poker/OL.png' position='0.27 0 0' width='.13' height='0.18' transparent='true' rotation='0 0 0' color='#FFFF00'></a-plane>
      
      
        
        <a-entity id='gridLines' position='0 0 -0.1'>
          <a-plane position='0 -0.6 0' width='2.5' height='0.01' rotation='0 0 0' color='#FFFFFF'></a-plane>
          <a-plane position='0 0.6 0' width='2.5' height='0.01' rotation='0 0 0' color='#FFFFFF'></a-plane>
          <a-plane position='0 0 0' width='2.5' height='0.01' rotation='0 0 0' color='#FFFFFF'></a-plane>
          <a-plane position='0.6 0 0' width='0.01' height='2.5' rotation='0 0 0' color='#FFFFFF'></a-plane>
          <a-plane position='-0.6 0 0' width='0.01' height='2.5' rotation='0 0 0' color='#FFFFFF'></a-plane>
          <a-plane position='0 0 0' width='0.01' height='2.5' rotation='0 0 0' color='#FFFFFF'></a-plane>
      </a-entity>
        
      </a-entity>
        
        <a-entity id='text' n-text="fontSize:3; width:4; text:" position="0 2.5 -2.5"></a-entity>
        
        <a-box position='0 0.3 0' width='.3' height='1' depth='.3' color='#281b08'></a-box>
        <a-box position='0 0.85 0' width='2.5' height='0.1' depth='2.5' color='#1f6322'></a-box>
        <a-box position='1.25 0.85 0' width='0.1' height='0.2' depth='2.6' color='#281b08'></a-box>
        <a-box position='-1.25 0.85 0' width='0.1' height='0.2' depth='2.6' color='#281b08'></a-box>
        <a-box position='0 0.85 1.25' width='2.6' height='0.2' depth='0.1' color='#281b08'></a-box>
        <a-box position='0 0.85 -1.25' width='2.6' height='0.2' depth='0.1' color='#281b08'></a-box>
        
        <a-entity position='0 0 4'>
            <a-camera></a-camera>
        </a-entity>
    </a-scene>
<script>
  var config = {
    baseRefUrl: "https://cubesync-f70b7.firebaseio.com",
    authorId: "BenG",
    appId: "PokerTest1"
  };
  Promise.all([
    altspace.utilities.sync.connect(config)
  ]).then(function(results) {
    connection = results[0];
    var syncedCards = connection.instance.child('syncedCards');
    var cards = ["C14", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "D14", "D2", "D3", "D4", "D5", "D6", "D7", "D8", "D9", "D10", "D11", "D12", "D13", "H14", "H2", "H3", "H4", "H5", "H6", "H7", "H8", "H9", "H10", "H11", "H12", "H13", "S14", "S2", "S3", "S4", "S5", "S6", "S7", "S8", "S9", "S10", "S11", "S12", "S13"];
    
    var selectedCards = [];
    var allHands = [];
    
    syncedCards.on('value', function(data) {
      if (data.val() == null) {
        selectedCards = [];
      } else if (selectedCards != data.val()) {
        selectedCards = data.val();
        updateSelCards();
        syncedCards.set(selectedCards);
        if (selectedCards.length == 7) {
            findHands();
        }
      }
    });
    
    for (var i = 0; i < 52; i++) {
        var box = document.createElement('a-plane');
        box.setAttribute('id', cards[i]);
        box.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/' + cards[i] + '.png');
        box.setAttribute('width', '0.12');
        box.setAttribute('height', '0.17');
        box.setAttribute('transparent', 'true');
        box.addEventListener('mousedown', function (event) { cardClick(event.target); });
        if (i < 26) {
            box.setAttribute('position', -1.875+(i*.15) + ' 0 0');
            console.log(i + ': ' + (-1.875+(i*.15)) + ' 0 0');
            document.querySelector('#row1').appendChild(box);
        } else {
            box.setAttribute('position', -1.875+((i-26)*.15) + ' 0 0');
            document.querySelector('#row2').appendChild(box);
        }
    }
    for (var i = 1; i<8; i++) {
        var box = document.createElement('a-plane');
        box.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/blank.png');
        box.setAttribute('id', 'sel' + i);
        box.setAttribute('width', '0.48');
        box.setAttribute('height', '0.68');
        box.setAttribute('position', (i-4)*.6 + ' 0 0');
        box.setAttribute('transparent', 'true');
        document.querySelector('#row3').appendChild(box);
        box.addEventListener('mousedown', function (event) { selCardClick(event.target); });
        var outline = document.createElement('a-plane');
        outline.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/OL.png');
        outline.setAttribute('width', '0.52');
        outline.setAttribute('height', '0.72');
        outline.setAttribute('position', (i-4)*.6 + ' 0 -0.001');
        outline.setAttribute('transparent', 'true');
        if (i < 6) {
            outline.setAttribute('color', 'yellow');
        } else {
            outline.setAttribute('color', 'red');
        }
        document.querySelector('#row3').appendChild(outline);
    }
  
    document.querySelector('#randomHand').addEventListener('mousedown', function (event) { randomise(); });
    document.querySelector('#clear').addEventListener('mousedown', function (event) { clear(); });
    createTable();
    function createTable() {
        for (var i = 0; i < 8; i++) {
            var playerSpot = document.createElement('a-entity');
            var outline = document.createElement('a-plane');
            outline.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/OL.png');
            outline.setAttribute('scale', '0.13 0.18 0');
            outline.setAttribute('transparent', 'true');
            outline.setAttribute('color', '#FFFF00');
            outline.setAttribute('position', '-0.07 0 0');
            playerSpot.appendChild(outline);
            var outline2 = document.createElement('a-plane');
            outline2.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/OL.png');
            outline2.setAttribute('scale', '0.13 0.18 0');
            outline2.setAttribute('transparent', 'true');
            outline2.setAttribute('color', '#FFFF00');
            outline2.setAttribute('position', '0.07 0 0');
            playerSpot.appendChild(outline2);
            
            //Add stuff here
            
            var foldButton = document.createElement('a-plane');
            foldButton.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/OL.png');
            foldButton.setAttribute('scale', '0.1 0.1 0');
            foldButton.setAttribute('transparent', 'true');
            foldButton.setAttribute('color', '#FFFF00');
            foldButton.setAttribute('position', '-0.1 -0.4 0');
            playerSpot.appendChild(foldButton);
            
            var checkButton = document.createElement('a-plane');
            checkButton.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/OL.png');
            checkButton.setAttribute('scale', '0.1 0.1 0');
            checkButton.setAttribute('transparent', 'true');
            checkButton.setAttribute('color', '#FFFF00');
            checkButton.setAttribute('position', '0 -0.4 0');
            playerSpot.appendChild(checkButton);
            
            var raiseButton = document.createElement('a-plane');
            raiseButton.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/OL.png');
            raiseButton.setAttribute('scale', '0.1 0.1 0');
            raiseButton.setAttribute('transparent', 'true');
            raiseButton.setAttribute('color', '#FFFF00');
            raiseButton.setAttribute('position', '0.1 -0.4 0');
            playerSpot.appendChild(raiseButton);
            
            var playerPot = document.createElement('a-plane');
            playerPot.setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/OL.png');
            playerPot.setAttribute('scale', '0.2 0.2 0');
            playerPot.setAttribute('transparent', 'true');
            playerPot.setAttribute('color', '#FFFF00');
            var potX = -1.05;
            if (i % 2) {
                console.log(i + ': odd');
                potX *= -1;
            }
            playerPot.setAttribute('position', potX + ' -0.4 0');
            playerSpot.appendChild(playerPot);
            
            var textA = document.createElement('a-entity');
            textA.setAttribute('n-text', 'fontSize:2; width:4; text:' + i)
            //playerSpot.appendChild(textA);
            
            
            
            
            
            var x = 0.3;
            var y = 0.6;
            var x2;
            var y2;
            playerSpot.setAttribute('id', 'player' + i + 1);
            if (i==0||i==3||i==5||i==6) {x2 = x;} else {x2 = x * -1;}
            if (i==4||i==5||i==6||i==7) {y2 = y;} else {y2 = y * -1;}
            if (i==2||i==3||i==6||i==7) {var tempI = y2; y2 = x2; x2 = tempI;}
            playerSpot.setAttribute('position', x2 + ' ' + y2 + ' 0');
            playerSpot.setAttribute('rotation', '0 0 ' + Math.floor(i/2) * -90);
            document.querySelector('#tableSurface').appendChild(playerSpot);
            console.log(i + ':  x: ' + x2 + '  y: ' + y2);
        }
    }
    function cardClick(el) {
        if (selectedCards.indexOf(el.id) < 0  && selectedCards.length < 7) {
            selectedCards.push(el.id);
            el.setAttribute('color', '#555555');
            document.querySelector('#sel' + selectedCards.length).setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/' + el.id + '.png');
        }
        syncedCards.set(selectedCards);
        if (selectedCards.length == 7) {
            //checkHand();
            findHands();
        }
    }
    function selCardClick(el) {
        if (el.id == 'sel1' && selectedCards.length > 0) {
            removeCard(1);
        } else if (el.id == 'sel2' && selectedCards.length > 1) {
            removeCard(2);
        } else if (el.id == 'sel3' && selectedCards.length > 2) {
            removeCard(3);
        } else if (el.id == 'sel4' && selectedCards.length > 3) {
            removeCard(4);
        } else if (el.id == 'sel5' && selectedCards.length > 4) {
            removeCard(5);
        } else if (el.id == 'sel6' && selectedCards.length > 5) {
            removeCard(6);
        } else if (el.id == 'sel7' && selectedCards.length > 6) {
            removeCard(7);
        }
        document.querySelector('#text').setAttribute('n-text', {fontSize:3, text:''});
        syncedCards.set(selectedCards);
    }
    function removeCard(i) {
        document.querySelector('#' + selectedCards[i-1]).setAttribute('color', '#FFFFFF');
        selectedCards.splice(i-1, 1);
        updateSelCards();
    }
    function updateSelCards() {
        selectedCards.forEach(updateSelCards2);
        if (selectedCards.length < 7) {
            var cardsToClear = 7 - selectedCards.length;
            for (var i = 0; i < cardsToClear; i++) {
                document.querySelector('#sel' + (7 - i)).setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/blank.png');
            }
        }
    }
    function updateSelCards2(value, index) {
        document.querySelector('#sel' + (index + 1)).setAttribute('src', 'https://bengarfield.github.io/AltVR-Tests/poker/' + value + '.png');
        document.querySelector('#sel' + (index + 1)).setAttribute('color', '#FFFFFF');
    }
    function randomise() {
        clear();
        var shuffledCards = cards;
        shuffleArray(shuffledCards);
        for (var i = 0; i < 7; i++) {
            cardClick(document.querySelector('#' + shuffledCards[i]));
        }
    }
    function clear() {
        for (var i = 0; i < 7; i++) {
            selCardClick(document.querySelector('#sel1'))
        }
    }
    function shuffleArray(array) {
        for (var i = array.length - 1; i > 0; i--) {
            var j = Math.floor(Math.random() * (i + 1));
            var temp = array[i];
            array[i] = array[j];
            array[j] = temp;
        }
        return array;
    }
    function findHands() {
        allHands = new Array;
    for (var i = 0; i < 10; i++) {
      var cards1 = JSON.parse(JSON.stringify(selectedCards))
      console.log(cards1);
      console.log(selectedCards);
      
      if (i == 0) {
          cards1.splice(0, 2);
      } else if (i == 1) {
          cards1.splice(2, 1);
          cards1.splice(0, 1);
      } else if (i == 2) {
          cards1.splice(3, 1);
          cards1.splice(0, 1);
      } else if (i == 3) {
          cards1.splice(4, 1);
          cards1.splice(0, 1);
      } else if (i == 4) {
          cards1.splice(1, 2);
      } else if (i == 5) {
          cards1.splice(3, 1);
          cards1.splice(1, 1);
      } else if (i == 6) {
          cards1.splice(4, 1);
          cards1.splice(1, 1);
      } else if (i == 7) {
          cards1.splice(2, 2);
      } else if (i == 8) {
          cards1.splice(4, 1);
          cards1.splice(2, 1);
      } else if (i == 9) {
          cards1.splice(3, 2);
      }
      console.log(i + ': ' + cards1);
      checkHand(cards1);
    }
    function compare(a,b) {
        if (a.score > b.score)
        return -1;
    if (a.score < b.score)
        return 1;
        return 0;
    }
    allHands.sort(compare);
    console.log(allHands);
    console.log(allHands[0]);
    document.querySelector('#text').setAttribute('n-text', {fontSize:3, text:allHands[0].hand + ": " + allHands[0].score})
    
    //Fade unused cards
    var bestHand = allHands[0].number;
    if (bestHand == 0 || bestHand == 1 || bestHand == 2 || bestHand == 3) {
        document.querySelector('#sel1').setAttribute('color', '#555555');
    }
    if (bestHand == 0 || bestHand == 4 || bestHand == 5 || bestHand == 6) {
        document.querySelector('#sel2').setAttribute('color', '#555555');
    }
    if (bestHand == 1 || bestHand == 4 || bestHand == 7 || bestHand == 8) {
        document.querySelector('#sel3').setAttribute('color', '#555555');
    }
    if (bestHand == 2 || bestHand == 5 || bestHand == 7 || bestHand == 9) {
        document.querySelector('#sel4').setAttribute('color', '#555555');
    }
    if (bestHand == 3 || bestHand == 6 || bestHand == 8 || bestHand == 9) {
        document.querySelector('#sel5').setAttribute('color', '#555555');
    }
    }
    function checkHand(selectedHand) {
        var suits = [];
        var values = [];
        var numOfSuits = 0;
        var isStreak = false;
        var streakVal = 0;
        var match1Num = 0;
        var match1Val = 0;
        var match2Num = 0;
        var match2Val = 0;
        var hand;
        var score;
        
        // Separate suits from values
        for (var i = 0; i < 5; i++) {
            //selectedHand.push(document.getElementById("card" + (i+1)).value);
            suits.push(selectedHand[i].slice(0, 1));
            values.push(Number(selectedHand[i].slice(1, selectedHand[i].length)));
        }

        // Count suits
        if (suits.indexOf("C") >= 0) {numOfSuits++;}
        if (suits.indexOf("D") >= 0) {numOfSuits++;}
        if (suits.indexOf("H") >= 0) {numOfSuits++;}
        if (suits.indexOf("S") >= 0) {numOfSuits++;}
        values.sort(function(a, b){return a-b});

        // Check for ace to five streak
        if (JSON.stringify(values) == JSON.stringify([2,3,4,5,14])) {values = [1,2,3,4,5];}

        // Check for streak
        if (values[0] == values[1] - 1 && values[1] == values[2] - 1 && values[2] == values[3] - 1 && values[3] == values[4] - 1) {
            isStreak = true;
            streakVal = values[4];
        }

        // Check for matching values
        for (var i = 1; i < 15; i++) {
            var count = 0;
            for (var j = 0; j < 5; j++) {
                if (values[j] == i) {count++;}
            }
            //alert(count);
            if (count > 1 && match1Num == 0) {
                match1Num = count;
                match1Val = i;
            } else if (count > 1) {
                match2Num = count;
                match2Val = i;
            }
        }

        // Asign hand type
        if (numOfSuits == 1 && streakVal == 14) {
            hand = "Royal Flush";
            score = 10;
        } else if (numOfSuits == 1 && streakVal > 0) {
            hand = "Straight Flush";
            score = 9 + (values[4] / 100);
        } else if (numOfSuits == 1) {
            hand = "Flush";
            score = 6 + (values[4] / 100);
        } else if (numOfSuits > 0 && streakVal > 0) {
            hand = "Straight";
            score = 5 + (values[4] / 100);
        } else if (match1Num == 4) {
            hand = "Four of a Kind"
            score = 8 + (match1Val / 100);
            // Add kicker
        } else if (match1Num == 2 && match2Num == 3) {
            hand = "Full House";
            score = 7 + (match2Val / 100) + (match1Val / 10000);
        } else if (match1Num == 3 && match2Num == 2) {
            hand = "Full House";
            score = 7 + (match1Val / 100) + (match2Val / 10000);
        } else if (match1Num == 3) {
            hand = "Three of a Kind";
            score = 4 + (match1Val / 100);
            // Add best side card
        } else if (match2Num == 3) {
            hand = "Three of a Kind";
            score = 4 + (match2Val / 100);
            // Add best side card
        } else if (match1Num == 2 && match2Num == 2) {
            hand = "Two Pair";
            if (match1Val > match2Val) {
                score = 3 + (match1Val / 100) + (match2Val / 10000);
            } else {
                score = 3 + (match2Val / 100) + (match1Val / 10000);
            }
        } else if (match1Num == 2) {
            hand = "One Pair";
            score = 2 + (match1Val / 100);
        } else if (match2Num == 2) {
            hand = "One Pair";
            score = 2 + (match2Val / 100);
        } else {
            hand = "High Card";
            score = 1 + (values[4] / 100);
        }
        
        allHands.push({number: allHands.length, hand: hand, score: score});
        //document.querySelector('#text').setAttribute('n-text', {fontSize:3, text:hand + ": " + score});
    }
    
      }).catch(function (err) {
    console.error(err.toString(), err);
  });
</script>
</body>
</html>